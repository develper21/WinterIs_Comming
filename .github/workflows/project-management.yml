name: Project Management

on:
  issues:
    types: [opened, closed, edited, assigned, unassigned]
  pull_request:
    types: [opened, closed, edited, ready_for_review, synchronize]
  push:
    branches: [main, develop]

jobs:
  # Auto-assign issues and PRs
  auto-assign:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' || github.event_name == 'pull_request'
    
    steps:
    - name: Auto-assign to project
      uses: actions/github-script@v7
      with:
        script: |
          // Get project board
          const projectBoard = await github.rest.projects.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          if (projectBoard.data.length === 0) {
            console.log('No project board found');
            return;
          }
          
          const project = projectBoard.data[0];
          
          // Get columns
          const columns = await github.rest.projects.listColumns({
            project_id: project.id,
          });
          
          // Find appropriate column
          let targetColumn;
          if (context.event_name === 'issues') {
            targetColumn = columns.data.find(col => col.name === 'To Do' || col.name === 'Backlog');
          } else if (context.event_name === 'pull_request') {
            targetColumn = columns.data.find(col => col.name === 'In Review' || col.name === 'To Do');
          }
          
          if (!targetColumn) {
            console.log('No appropriate column found');
            return;
          }
          
          // Create project card
          if (context.event_name === 'issues') {
            await github.rest.projects.createCard({
              column_id: targetColumn.id,
              content_id: context.payload.issue.id,
              content_type: 'Issue',
            });
            console.log(`Issue #${context.payload.issue.number} added to project board`);
          } else if (context.event_name === 'pull_request') {
            await github.rest.projects.createCard({
              column_id: targetColumn.id,
              content_id: context.payload.pull_request.id,
              content_type: 'PullRequest',
            });
            console.log(`PR #${context.payload.pull_request.number} added to project board`);
          }

  # Update project status based on PR status
  update-project-status:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Update project status
      uses: actions/github-script@v7
      with:
        script: |
          const { action, pull_request } = context.payload;
          
          // Get project board
          const projectBoard = await github.rest.projects.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          if (projectBoard.data.length === 0) {
            return;
          }
          
          const project = projectBoard.data[0];
          
          // Get columns
          const columns = await github.rest.projects.listColumns({
            project_id: project.id,
          });
          
          // Find cards for this PR
          const cards = await github.rest.projects.listCards({
            column_id: columns.data[0].id,
          });
          
          const prCard = cards.data.find(card => 
            card.content_id === pull_request.id && card.content_type === 'PullRequest'
          );
          
          if (!prCard) {
            return;
          }
          
          // Move card based on PR status
          let targetColumnName;
          if (action === 'closed' && pull_request.merged) {
            targetColumnName = 'Done';
          } else if (action === 'closed' && !pull_request.merged) {
            targetColumnName = 'Rejected';
          } else if (action === 'ready_for_review') {
            targetColumnName = 'In Review';
          } else {
            return;
          }
          
          const targetColumn = columns.data.find(col => col.name === targetColumnName);
          
          if (targetColumn) {
            await github.rest.projects.moveCard({
              card_id: prCard.id,
              position: 'top',
              column_id: targetColumn.id,
            });
            console.log(`PR #${pull_request.number} moved to ${targetColumnName}`);
          }

  # Sprint planning automation
  sprint-automation:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Check for new release
      uses: actions/github-script@v7
      with:
        script: |
          // Check if this is a new release
          const packageJson = await github.rest.repos.getContent({
            owner: context.repo.owner,
            repo: context.repo.repo,
            path: 'Backend/package.json',
          });
          
          const pkg = JSON.parse(Buffer.from(packageJson.data.content, 'base64').toString());
          const version = pkg.version;
          
          // Check if release tag exists
          try {
            await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: `v${version}`,
            });
            console.log(`Release v${version} already exists`);
            return;
          } catch (error) {
            // Release doesn't exist, create it
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${version}`,
              name: `Release v${version}`,
              body: `## Release v${version}\n\n### Features\n### Bug Fixes\n### Improvements\n\n**Deployed to:** Production`,
              draft: false,
              prerelease: false,
            });
            
            console.log(`Created release v${version}`);
            
            // Create project card for release
            const projectBoard = await github.rest.projects.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            if (projectBoard.data.length > 0) {
              const project = projectBoard.data[0];
              const columns = await github.rest.projects.listColumns({
                project_id: project.id,
              });
              
              const releaseColumn = columns.data.find(col => col.name === 'Released' || col.name === 'Done');
              
              if (releaseColumn) {
                await github.rest.projects.createCard({
                  column_id: releaseColumn.id,
                  note: `Release v${version}`,
                });
              }
            }
          }
