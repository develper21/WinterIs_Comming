input {
  beats {
    port => 5044
  }
  tcp {
    port => 5000
    codec => json
  }
  udp {
    port => 5000
    codec => json
  }
}

filter {
  # Parse application logs
  if [fields][service] == "bloodbank-backend" {
    json {
      source => "message"
    }
    
    # Add timestamp if not present
    if ![timestamp] {
      mutate {
        add_field => { "timestamp" => "%{@timestamp}" }
      }
    }
    
    # Parse log level
    if [level] {
      mutate {
        add_tag => [ "%{level}" ]
      }
    }
    
    # Add environment tag
    if [fields][environment] {
      mutate {
        add_field => { "environment" => "%{[fields][environment]}" }
      }
    }
  }
  
  # Parse nginx logs
  if [fields][service] == "nginx" {
    grok {
      match => { 
        "message" => "%{NGINXACCESS}" 
      }
    }
    
    # Parse user agent
    if [agent] {
      useragent {
        source => "agent"
        target => "user_agent"
      }
    }
    
    # Convert response time to float
    if [response_time] {
      mutate {
        convert => { "response_time" => "float" }
      }
    }
  }
  
  # Add geoip for client IP
  if [clientip] {
    geoip {
      source => "clientip"
      target => "geoip"
    }
  }
  
  # Clean up fields
  mutate {
    remove_field => [ "host", "agent", "ecs", "input", "log" ]
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "bloodbank-logs-%{+YYYY.MM.dd}"
    template_name => "bloodbank"
    template => {
      "index_patterns" => ["bloodbank-logs-*"],
      "settings" => {
        "number_of_shards" => 1,
        "number_of_replicas" => 0
      },
      "mappings" => {
        "properties" => {
          "@timestamp" => { "type" => "date" },
          "level" => { "type" => "keyword" },
          "service" => { "type" => "keyword" },
          "environment" => { "type" => "keyword" },
          "requestId" => { "type" => "keyword" },
          "method" => { "type" => "keyword" },
          "path" => { "type" => "keyword" },
          "statusCode" => { "type" => "integer" },
          "responseTime" => { "type" => "float" },
          "userCode" => { "type" => "keyword" },
          "organizationCode" => { "type" => "keyword" },
          "ip" => { "type" => "ip" },
          "geoip" => {
            "location" => { "type" => "geo_point" }
          }
        }
      }
    }
  }
  
  # Debug output (remove in production)
  stdout {
    codec => rubydebug
  }
}
